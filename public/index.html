<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>MagicCats ‚Äî –¥—É—ç–ª—å</title>
<style>
  :root{
    --bg:#151316;
    --panel:#201e23;
    --line:#2a2a32;
    --txt:#eaeaf0;
    --muted:#bfc3cf;
    --hp:#6ee776;
    --mp:#63b7ff;
    --accent:#f7c66a;
    --danger:#ff6b6b;
    --win:#6dd96d; --lose:#ff7777; --draw:#ffd166;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:radial-gradient(120% 90% at 50% 10%, #2b2630 0%, var(--bg) 70%);
    color:var(--txt); font:16px/1.4 system-ui,Segoe UI,Roboto,Arial,sans-serif;
    min-height:100svh; display:flex; align-items:center; justify-content:center;
  }
  .wrap{width:min(720px,100%); padding:16px}
  .card{background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:14px; margin:10px 0}

  /* ===== HUD ===== */
  #battleUI{position:relative; overflow:hidden}
  .topHud{
    display:flex; justify-content:space-between; align-items:flex-start; padding:6px 4px 8px;
    font-weight:800; letter-spacing:.5px; color:var(--accent);
  }
  .bigNum{font-size:34px}
  .round{font-size:20px}
  .centerBoard{
    position:relative; margin:10px 0; padding:10px;
    border:2px solid var(--accent); border-radius:14px; background-color:rgba(247,198,106,0.15);
    height:220px; display:flex; align-items:center; justify-content:center; gap:24px;
  }
  .slot{
    width:140px; height:140px; border:4px solid var(--accent); border-radius:999px;
    display:flex; align-items:center; justify-content:center; background:#2a2530;
    position:relative; box-shadow:0 0 0 3px rgba(0,0,0,.1) inset;
  }
  .icon{font-size:64px; filter:drop-shadow(0 2px 0 rgba(0,0,0,.35))}
  .qmark{font-size:56px; color:#ddd}
  .history{
    position:absolute; right:-8px; top:8px; display:flex; flex-direction:column; gap:6px;
  }
  .hItem{display:flex; align-items:center; gap:4px; opacity:.9}
  .hItem .mini{width:30px; height:30px; border-radius:999px; border:2px solid var(--accent);
    display:flex; align-items:center; justify-content:center; background:#2a2530; font-size:18px}
  .hItem.faded1{opacity:.6} .hItem.faded2{opacity:.3}

  /* bars & avatars */
  .bars{display:flex; align-items:center; gap:12px; margin:6px 0}
  .avatar{width:68px; height:68px; border-radius:999px; border:6px solid var(--accent); background:#3a3242; position:relative}
  .barBox{flex:1}
  .bar{height:16px; background:#2b2e36; border-radius:999px; overflow:hidden; border:1px solid #3b3f4c}
  .hp{--c:var(--hp)} .mp{--c:var(--mp)}
  .fill{height:100%; width:100%; background:var(--c)}
  .label{font-size:12px; color:var(--muted)}

  /* buttons */
  .pad{padding-top:6px}
  .btnRow{display:flex; justify-content:space-between; gap:14px; margin-top:6px}
  .skill{flex:1; aspect-ratio:1/1; border-radius:999px; border:4px solid var(--accent); background:#302a39; color:#fff;
    font-size:22px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:.12s transform, .12s opacity}
  .skill:disabled{opacity:.45; cursor:default}
  .skill:active{transform:translateY(1px)}
  .sFire .icon{font-size:34px} .sIce .icon{font-size:34px} .sAir .icon{font-size:34px}

  .hint{margin-top:4px; font-size:12px; color:var(--muted)}
  .center{display:flex; align-items:center; justify-content:center}
  .win{color:var(--win)} .lose{color:var(--lose)} .draw{color:var(--draw)}

  /* float damage */
  .float{position:absolute; font-weight:900; font-size:26px; transform:translate(-50%,-10px); pointer-events:none; opacity:0; text-shadow:0 2px 0 rgba(0,0,0,.4)}
  .float.show{animation:rise .9s ease-out forwards}
  @keyframes rise{from{opacity:0; transform:translate(-50%,10px)} 35%{opacity:1} to{opacity:0; transform:translate(-50%,-40px)}}

  /* Lobby (–æ—Å—Ç–∞–≤–∏–ª–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ) */
  .row{display:flex; gap:8px; flex-wrap:wrap}
  input,button{font-size:16px; padding:10px; border-radius:10px; border:1px solid var(--line); background:#16161b; color:var(--txt)}
  button{cursor:pointer}
  pre{background:#0f1420; color:#ddd; padding:10px; border-radius:8px; white-space:pre-wrap; overflow:auto; max-height:220px}
</style>

<div class="wrap">

  <!-- ====== –õ–û–ë–ë–ò ====== -->
  <div id="lobby" class="card">
    <h2 style="margin:.2em 0 .6em">MagicCats ‚Äî –ª–æ–±–±–∏</h2>
    <div class="row">
      <input id="name" placeholder="–¢–≤–æ—ë –∏–º—è" style="flex:1">
      <button id="btnCreate">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
    </div>

    <div id="hostBlock" style="display:none;margin-top:10px">
      <div>–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã: <b id="roomCode"></b></div>
      <div>–¢–æ–∫–µ–Ω –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è: <b id="inviteToken"></b></div>
      <div class="row" style="margin-top:6px">
        <input id="inviteLink" style="flex:1">
        <button id="copyLink">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
      <div class="hint">–û—Ç–ø—Ä–∞–≤—å —Å—Å—ã–ª–∫—É –¥—Ä—É–≥—É.</div>
    </div>

    <hr style="border:none;height:1px;background:#2a2f3a;margin:14px 0">

    <div class="row">
      <input id="joinName" placeholder="–ò–º—è –≥–æ—Å—Ç—è" style="flex:1">
    </div>
    <div class="row" style="margin-top:8px">
      <input id="joinCode"  placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã (–Ω–∞–ø—Ä., 7Y3KQ)" style="flex:1">
      <input id="joinToken" placeholder="–¢–æ–∫–µ–Ω (6 —Å–∏–º–≤.)" style="flex:1">
      <button id="btnJoin">–í–æ–π—Ç–∏</button>
    </div>

    <div class="card" style="margin:12px -14px -14px; border-radius:0 0 16px 16px">
      <div class="hint">–°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã</div>
      <pre id="state"></pre>
    </div>
  </div>

  <!-- ====== –ë–û–ô ====== -->
  <div id="battle" class="card" style="display:none">
    <div id="battleUI">

      <div class="topHud">
        <div>–•–û–î <span class="bigNum" id="secLeft">15</span></div>
        <div class="round">–†–∞—É–Ω–¥ <span id="roundNow">1</span>/<span id="roundMax">3</span></div>
      </div>

      <!-- –æ–ø–ø–æ–Ω–µ–Ω—Ç -->
      <div class="bars">
        <div class="avatar" id="oppAvatar"></div>
        <div class="barBox" style="flex:1">
          <div class="label">HP</div>
          <div class="bar hp"><div class="fill" id="oppHpFill" style="width:100%"></div></div>
          <div class="label" style="margin-top:6px">–ú–∞–Ω–∞</div>
          <div class="bar mp"><div class="fill" id="oppMpFill" style="width:100%"></div></div>
        </div>
      </div>

      <!-- —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ -->
      <div class="centerBoard" id="board">
        <div class="slot"><div id="myBigIcon" class="icon"></div></div>
        <div class="slot"><div id="oppBigIcon" class="icon qmark">?</div></div>

        <div class="history" id="history"></div>
      </div>

      <!-- —Ç—ã -->
      <div class="bars">
        <div class="avatar" id="youAvatar"></div>
        <div class="barBox" style="flex:1">
          <div class="label">HP</div>
          <div class="bar hp"><div class="fill" id="youHpFill" style="width:100%"></div></div>
          <div class="label" style="margin-top:6px">–ú–∞–Ω–∞</div>
          <div class="bar mp"><div class="fill" id="youMpFill" style="width:100%"></div></div>
        </div>
      </div>

      <!-- –∫–Ω–æ–ø–∫–∏ -->
      <div class="pad">
        <div class="btnRow">
          <button class="skill sFire"  id="btnFire"><span class="icon">üî•</span></button>
          <button class="skill sAir"   id="btnShield"><span class="icon">üå¨Ô∏è</span></button>
          <button class="skill sIce"   id="btnIce"><span class="icon">‚ùÑÔ∏è</span></button>
        </div>
        <div class="hint" id="moveHint">–ñ–¥–∏ –Ω–∞—á–∞–ª–∞ —Ö–æ–¥–∞‚Ä¶</div>
      </div>
    </div>
  </div>

  <!-- ====== –§–ò–ù–ê–õ ====== -->
  <div id="result" class="card center" style="display:none">
    <div style="text-align:center">
      <h2 id="matchResultText">‚Äî</h2>
      <div id="finalScore" class="hint"></div>
      <div style="height:8px"></div>
      <div class="hint">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–∑–∞ –º–∞—Ç—á)</div>
      <div id="youStats"  class="hint"></div>
      <div id="oppStats"  class="hint"></div>
    </div>
  </div>

</div>

<!-- –ø—Ä–æ—Å—Ç–µ–Ω—å–∫–∏–π ‚Äú–¥–∑—ã–Ω—å–∫‚Äù -->
<audio id="ding" preload="auto">
  <source src="data:audio/wav;base64,UklGRmQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYBHQB+AAAAgAAAAP8AAP8A/wD/AP//AAD/AP8A/wAAAP8AAP//AP//AAAA/wAA//8A//8AAAAA" type="audio/wav">
</audio>

<script src="/socket.io/socket.io.js"></script>
<script>
/* ===== helpers & state ===== */
const $ = id => document.getElementById(id);
const socket = io();

let code=null, isHost=false, myRole=null, oppRole=null;
let hpMax=30, mpMax=10;

const ICON = { fire:'üî•', ice:'‚ùÑÔ∏è', shield:'üå¨Ô∏è', none:'' };

function setBtnsEnabled(on){
  $('btnFire').disabled = $('btnIce').disabled = $('btnShield').disabled = !on;
  $('moveHint').textContent = on ? '–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ —Ç–∞–π–º–µ—Ä—É' : '–û–∂–∏–¥–∞–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ö–æ–¥–∞‚Ä¶';
}

function setBars(role, hp, mp){
  const hpFill = role==='me' ? $('youHpFill') : $('oppHpFill');
  const mpFill = role==='me' ? $('youMpFill') : $('oppMpFill');
  hpFill.style.width = Math.max(0, Math.min(100, Math.round(hp/hpMax*100))) + '%';
  mpFill.style.width = Math.max(0, Math.min(100, Math.round(mp/mpMax*100))) + '%';
}

function floatDamage(targetEl, value, isMe){
  const el = document.createElement('div');
  el.className = 'float show';
  el.style.left = '50%';
  el.style.color = value>0 ? (isMe? 'var(--danger)' : 'var(--danger)') : 'var(--muted)';
  el.textContent = value>0 ? `-${value}` : '';
  targetEl.appendChild(el);
  setTimeout(()=> el.remove(), 1000);
}

function pushHistory(myAct, oppAct, winner){
  // winner: 'host'|'guest'|'draw' (–∫—Ç–æ –Ω–∞–Ω–µ—Å —É—Ä–æ–Ω / –ø–æ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫—É)
  const box = $('history');
  // —Å–º–µ—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã faded
  [...box.children].forEach((c,i)=>{
    c.classList.remove('faded1','faded2');
    c.classList.add(i===0?'faded1':'faded2');
    if(i>=2) c.style.opacity=.25;
  });

  const item = document.createElement('div');
  item.className = 'hItem';
  const top = document.createElement('div');
  const bottom = document.createElement('div');
  top.className = bottom.className = 'mini';

  const myMini  = document.createElement('div'); myMini.className='mini'; myMini.textContent=ICON[myAct||'none']||'¬∑';
  const oppMini = document.createElement('div'); oppMini.className='mini'; oppMini.textContent=ICON[oppAct||'none']||'¬∑';

  // –ø–æ–±–µ–¥–∏–≤—à–∏–π —Å–≤–µ—Ä—Ö—É: –µ—Å–ª–∏ –Ω–∏—á—å—è ‚Äî –Ω–∞—à —Å–≤–µ—Ä—Ö—É
  if (winner==='draw') { top.textContent = ICON[myAct]||'¬∑'; bottom.textContent = ICON[oppAct]||'¬∑'; }
  else if ((winner==='host' && isHost) || (winner==='guest' && !isHost)) {
    top.textContent = ICON[myAct]||'¬∑'; bottom.textContent = ICON[oppAct]||'¬∑';
  } else {
    top.textContent = ICON[oppAct]||'¬∑'; bottom.textContent = ICON[myAct]||'¬∑';
  }

  item.appendChild(top);
  item.appendChild(bottom);
  box.prepend(item);
  // –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ 3
  while(box.children.length>3) box.lastChild.remove();
}

/* ===== Lobby ===== */
$('btnCreate').onclick = ()=> socket.emit('create', { name: $('name').value.trim() || 'Host' });
socket.on('created', ({code:roomCode, inviteToken})=>{
  isHost = true; code = roomCode;
  $('roomCode').textContent = roomCode;
  $('inviteToken').textContent = inviteToken;
  const url = new URL(location.href); url.searchParams.set('code',roomCode); url.searchParams.set('token',inviteToken);
  $('inviteLink').value = url.toString();
  $('hostBlock').style.display='block';
});
$('btnJoin').onclick = ()=>{
  const c=$('joinCode').value.trim(), t=$('joinToken').value.trim(), n=$('joinName').value.trim()||'Guest';
  if(!c||!t) return alert('–ù—É–∂–Ω—ã –∫–æ–¥ –∏ —Ç–æ–∫–µ–Ω');
  socket.emit('joinWithToken', {code:c, token:t, name:n});
};

/* ===== Auto-fill from URL ===== */
(() => {
  const p = new URLSearchParams(location.search);
  const c=p.get('code'), t=p.get('token'); if(c&&t){ $('joinCode').value=c; $('joinToken').value=t; }
})();

socket.on('state', s => { $('state').textContent = JSON.stringify(s,null,2); });
socket.on('error_msg', m=> alert(m));

/* ===== Countdown / Start ===== */
socket.on('countdown', ({n})=>{
  $('lobby').style.display='block';
});
socket.on('duel_start', s=>{
  myRole = isHost ? 'host':'guest'; oppRole = myRole==='host'?'guest':'host';
  hpMax = s.hpMax; mpMax = s.manaMax;

  $('lobby').style.display='none';
  $('result').style.display='none';
  $('battle').style.display='block';

  $('roundNow').textContent = s.round;
  $('roundMax').textContent = s.maxRounds;

  setBars('me',    s.hp[myRole],  s.mana[myRole]);
  setBars('opp',   s.hp[oppRole], s.mana[oppRole]);

  $('history').innerHTML='';
  $('myBigIcon').textContent='';
  $('oppBigIcon').textContent='?';
  setBtnsEnabled(false);
});

/* ===== Turn start / timer ===== */
let secTimer=null;
function startTimer(deadlineTs){
  stopTimer();
  const tick=()=>{
    const left = Math.max(0, Math.ceil((deadlineTs-Date.now())/1000));
    $('secLeft').textContent = left;
    if(left<=0) stopTimer();
  };
  tick(); secTimer=setInterval(tick, 200);
}
function stopTimer(){ if(secTimer){clearInterval(secTimer); secTimer=null;} }

socket.on('turn_start', ({round, maxRounds, turnNo, deadlineTs})=>{
  $('roundNow').textContent = round; $('roundMax').textContent = maxRounds;
  $('myBigIcon').textContent=''; $('oppBigIcon').textContent='?';
  setBtnsEnabled(true);
  startTimer(deadlineTs);
});

/* ===== Choose ===== */
function choose(action){
  if(!code) code = $('joinCode').value.trim();
  const role = isHost?'host':'guest';
  setBtnsEnabled(false);
  $('myBigIcon').textContent = ICON[action]||'';
  socket.emit('choose_action', { code, role, action });
}
$('btnFire').onclick  = ()=> choose('fire');
$('btnIce').onclick   = ()=> choose('ice');
$('btnShield').onclick= ()=> choose('shield');

/* ===== Feedback while choosing ===== */
socket.on('action_made', ({by, action})=>{
  if(by === (isHost?'host':'guest')){
    // –º—ã ‚Äî —É–∂–µ –ø–æ–∫–∞–∑–∞–ª–∏ –±–æ–ª—å—à—É—é –∏–∫–æ–Ω–∫—É
  }else{
    $('oppBigIcon').textContent = 'Ôºü'; // —Å–∫—Ä—ã–≤–∞–µ–º –¥–æ –∫–æ–Ω—Ü–∞ —Ö–æ–¥–∞
  }
});

/* ===== Turn end (resolve) ===== */
socket.on('turn_end', ({reason, turnNo, actionsRaw, actionsUsed, damage, hp, mana})=>{
  stopTimer();
  const myUse  = actionsUsed?.[isHost?'host':'guest'] || null;
  const oppUse = actionsUsed?.[isHost?'guest':'host'] || null;

  // –ø–æ–∫–∞–∑ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ –ø–æ—Å–ª–µ —Ä–∞—Å—á—ë—Ç–∞
  $('oppBigIcon').textContent = ICON[oppUse] || '¬∑';

  // bars & damage floats
  const myHp = hp[isHost?'host':'guest'];
  const opHp = hp[isHost?'guest':'host'];
  const myMp = mana[isHost?'host':'guest'];
  const opMp = mana[isHost?'guest':'host'];

  const dmgToOpp = damage?.host || 0;
  const dmgToMe  = damage?.guest || 0;

  setBars('me',  myHp, myMp);
  setBars('opp', opHp, opMp);
  if(dmgToMe>0)  floatDamage($('youAvatar'), dmgToMe, true);
  if(dmgToOpp>0) floatDamage($('oppAvatar'), dmgToOpp, false);

  // –≤—ã—á–∏—Å–ª–∏–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –ø–∞—Ä—ã –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
  let winner='draw';
  if(dmgToOpp>0 && dmgToMe===0) winner = isHost ? 'host':'guest';
  else if(dmgToMe>0 && dmgToOpp===0) winner = isHost ? 'guest':'host';

  pushHistory(myUse, oppUse, winner);

  // ‚Äú–¥–∑—ã–Ω—å–∫‚Äù
  $('ding').currentTime = 0;
  $('ding').play().catch(()=>{});
});

/* ===== Round / Battle end ===== */
socket.on('round_over', ({round, winner, hp, score})=>{
  // –Ω–∏—á–µ–≥–æ –æ—Å–æ–±–æ–≥–æ –≤ UI –ø–æ–∫–∞ –Ω–µ –¥–µ–ª–∞–µ–º ‚Äî –ø—Ä–æ—Å—Ç–æ –∫–Ω–æ–ø–∫–∏ –≤—ã–∫–ª—é—á–µ–Ω—ã
  setBtnsEnabled(false);
});
socket.on('battle_over', ({matchWinner, score, used})=>{
  $('battle').style.display='none';
  $('result').style.display='flex';

  const text =
    matchWinner==='draw' ? '–ù–∏—á—å—è' :
    (matchWinner===(isHost?'host':'guest') ? '–¢—ã –≤—ã–∏–≥—Ä–∞–ª!' : '–¢—ã –ø—Ä–æ–∏–≥—Ä–∞–ª');
  $('matchResultText').textContent = text;
  $('matchResultText').className = matchWinner==='draw' ? 'draw' :
    (matchWinner===(isHost?'host':'guest') ? 'win':'lose');
  $('finalScore').textContent = `–ò—Ç–æ–≥ –ø–æ —Ä–∞—É–Ω–¥–∞–º: ${score.host} ‚Äî ${score.guest}`;

  const myU = used[isHost?'host':'guest'] || {};
  const opU = used[isHost?'guest':'host'] || {};
  $('youStats').textContent = `–¢—ã ‚Äî üî•:${myU.fire||0} ‚ùÑÔ∏è:${myU.ice||0} üå¨Ô∏è:${myU.shield||0}`;
  $('oppStats').textContent = `–°–æ–ø–µ—Ä–Ω–∏–∫ ‚Äî üî•:${opU.fire||0} ‚ùÑÔ∏è:${opU.ice||0} üå¨Ô∏è:${opU.shield||0}`;
});

/* Copy invite link */
$('copyLink').onclick = async ()=>{
  try{
    await navigator.clipboard.writeText($('inviteLink').value);
    alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞');
  }catch{ alert('–ù–µ —É–¥–∞–ª–æ—Å—å ‚Äî —Å–∫–æ–ø–∏—Ä—É–π –≤—Ä—É—á–Ω—É—é.'); }
};
</script>
